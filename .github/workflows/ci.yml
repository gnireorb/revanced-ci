name: CI

on:
  workflow_dispatch:

jobs:
  update-system:
    runs-on: ubuntu-latest
    steps:
      - name: Update the system
        run: sudo apt install aria2 curl ripgrep
  build-youtube:
    needs: update-system
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'
      - name: Build YouTube
        run: |
          export additional_args="-e always-autorepeat -e custom-branding -i enable-wide-searchbar"
          sh -c "$(curl https://raw.githubusercontent.com/gnireorb/revanced-ci/main/patch.sh)"
          
      - name: Check if YouTube apk is created
        id: check_files
        uses: andstor/file-existence-action@v2
        with:
          files: "revanced-youtube-*.apk"
          fail: true

      - name: Upload build artifact
        uses: actions/upload-artifact@v3
        with:
          name: YouTube
          path: |
            revanced-youtube-*.apk
  build-reddit:
    needs: update-system
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'
      - name: Build Reddit
        run: |
          export what_to_patch="reddit"
          sh -c "$(curl https://raw.githubusercontent.com/gnireorb/revanced-ci/main/patch.sh)"
          
      - name: Check if Reddit apk is created
        id: check_files
        uses: andstor/file-existence-action@v2
        with:
          files: "revanced-reddit-*.apk"
          fail: true

      - name: Upload build artifact
        uses: actions/upload-artifact@v3
        with:
          name: Reddit
          path: |
            revanced-reddit-*.apk     
  build-x:
    needs: update-system
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'
      - name: Build X
        run: |
          export what_to_patch="x"
          sh -c "$(curl https://raw.githubusercontent.com/gnireorb/revanced-ci/main/patch.sh)"
          
      - name: Check if X apk is created
        id: check_files
        uses: andstor/file-existence-action@v2
        with:
          files: "revanced-x-*.apk"
          fail: true

      - name: Upload build artifact
        uses: actions/upload-artifact@v3
        with:
          name: X
          path: |
            revanced-x-*.apk
            
  build-infinity:
    needs: update-system
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'
      - name: Build Infinity
        run: |
          export what_to_patch="infinity"
          sh -c "$(curl https://raw.githubusercontent.com/gnireorb/revanced-ci/main/patch.sh)"
          
      - name: Check if Infinity apk is created
        id: check_files
        uses: andstor/file-existence-action@v2
        with:
          files: "revanced-infinity-*.apk"
          fail: true

      - name: Upload build artifact
        uses: actions/upload-artifact@v3
        with:
          name: Infinity
          path: |
            revanced-infinity-*.apk
